<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>‡∏à‡∏≠‡∏á‡∏Ñ‡∏¥‡∏ß</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- LIFF -->
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

<style>
body{
  margin:0;
  font-family: "Segoe UI", sans-serif;
  background:#e5e7eb;
  min-height:100vh;
  display:flex;
  align-items:center;
  justify-content:center;
}

.card{
  background:#fff;
  width:100%;
  max-width:400px;
  padding:24px;
  border-radius:18px;
  box-shadow:0 10px 25px rgba(0,0,0,.15);
  text-align:center;
}

h1{ margin-top:0; color:#111827; }

.user{ color:#6b7280; margin-bottom:15px; }

.info{
  background:#f3f4f6;
  padding:16px;
  border-radius:12px;
  margin-bottom:15px;
  white-space:pre-line;
}

button{
  width:100%;
  padding:16px;
  border-radius:14px;
  border:none;
  font-size:16px;
  font-weight:bold;
  cursor:pointer;
  margin-top:10px;
}

.btn-main{ background:#374151; color:#fff; }
.btn-danger{ background:#dc2626; color:#fff; }

button:disabled{ background:#9ca3af; }
</style>
</head>

<body>

<div class="card">
  <h1>üìã ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≠‡∏á‡∏Ñ‡∏¥‡∏ß</h1>

  <div class="user" id="welcome">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>

  <div id="content"></div>
</div>

<script>

const LIFF_ID = "2008930440-jI56TpIn"
const API_URL = "https://script.google.com/macros/s/AKfycbzLpYZsCxr1Hd9Knsp_fBFLQ6PhqQFl4YjnDOPhE3HugxFVgVzSY6IlaEYT7NzhzCIn/exec"


let profile = null;

/* ===== INIT ===== */
window.onload = async () => {
  try{
    await liff.init({ liffId: LIFF_ID });
    if(!liff.isLoggedIn()){
      liff.login();
      return;
    }

    profile = await liff.getProfile();
    welcome.innerText = "‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏∏‡∏ì " + profile.displayName;

    checkQueue();

  }catch(e){
    welcome.innerText = "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î LINE ‡πÑ‡∏î‡πâ";
  }
};

/* ===== CHECK QUEUE ===== */
function checkQueue(){
  content.innerHTML = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏¥‡∏ß...";

  fetch(API_URL,{
    method:"POST",
    body:JSON.stringify({
      action:"checkQueue",
      userId: profile.userId
    })
  })
  .then(r=>r.json())
  .then(d=>{
    if(d.hasQueue){
      showHasQueue(d);
    }else{
      showReserve();
    }
  });
}

/* ===== SHOW NO QUEUE ===== */
function showReserve(){
  content.innerHTML = `
    <button class="btn-main" onclick="reserve()">‡∏à‡∏≠‡∏á‡∏Ñ‡∏¥‡∏ß</button>
  `;
}

/* ===== SHOW HAS QUEUE ===== */
function showHasQueue(d){
  content.innerHTML = `
    <div class="info">
üë§ ${profile.displayName}
üéü ‡∏Ñ‡∏¥‡∏ß‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì: #${d.queue}
üìå ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${d.status}
    </div>

    <button class="btn-danger" onclick="cancelQueue()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Ñ‡∏¥‡∏ß</button>
  `;
}

/* ===== RESERVE ===== */
function reserve(){
  content.innerHTML = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏≠‡∏á‡∏Ñ‡∏¥‡∏ß...";

  fetch(API_URL,{
    method:"POST",
    body:JSON.stringify({
      action:"reserve",
      userId: profile.userId,
      name: profile.displayName
    })
  })
  .then(()=>checkQueue());
}

/* ===== CANCEL ===== */
function cancelQueue(){
  if(!confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Ñ‡∏¥‡∏ß‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) return;

  content.innerHTML = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Ñ‡∏¥‡∏ß...";

  fetch(API_URL,{
    method:"POST",
    body:JSON.stringify({
      action:"cancelQueue",
      userId: profile.userId
    })
  })
  .then(()=>checkQueue());
}
</script>

</body>
</html>
