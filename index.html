<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>‡∏à‡∏≠‡∏á‡∏Ñ‡∏¥‡∏ß</title>

<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

<style>
body {
  font-family: system-ui, sans-serif;
  background:#e5e7eb;
  margin:0;
  padding:20px;
}
.card {
  background:white;
  max-width:420px;
  margin:auto;
  border-radius:18px;
  padding:24px;
  box-shadow:0 10px 30px rgba(0,0,0,.12);
}
h2 { margin-top:0 }
.info {
  background:#f3f4f6;
  border-radius:12px;
  padding:16px;
  margin:12px 0;
}
button {
  width:100%;
  padding:16px;
  border-radius:14px;
  border:none;
  font-size:16px;
  cursor:pointer;
}
.primary { background:#111827; color:white }
.danger { background:#ef4444; color:white }
.gray { background:#9ca3af; color:white }
.hidden { display:none }
</style>
</head>

<body>

<div class="card">
  <h2 id="title">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</h2>

  <div id="queueInfo" class="info hidden"></div>

  <button id="bookBtn" class="primary hidden" onclick="bookQueue()">
    ‡∏à‡∏≠‡∏á‡∏Ñ‡∏¥‡∏ß
  </button>

  <button id="cancelBtn" class="danger hidden" onclick="cancelQueue()">
    ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Ñ‡∏¥‡∏ß
  </button>
</div>

<script>
const LIFF_ID = "2008930440-jI56TpIn"
const API_URL = "https://script.google.com/macros/s/AKfycbzLpYZsCxr1Hd9Knsp_fBFLQ6PhqQFl4YjnDOPhE3HugxFVgVzSY6IlaEYT7NzhzCIn/exec"

let profile = null

/* ===== INIT ===== */
async function init() {
  try {
    await liff.init({ liffId: LIFF_ID })
    if (!liff.isLoggedIn()) {
      liff.login()
      return
    }

    profile = await liff.getProfile()
    checkQueue()

  } catch {
    document.getElementById("title").innerText =
      "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡∏ú‡πà‡∏≤‡∏ô LINE"
  }
}

/* ===== CHECK QUEUE ===== */
function checkQueue() {
  fetch(API_URL,{
    method:"POST",
    body:JSON.stringify({
      action:"checkQueue",
      userId: profile.userId
    })
  })
  .then(r=>r.json())
  .then(d=>{
    if (d.status === "exists") {
      showQueue(d)
    } else {
      showBooking()
    }
  })
}

/* ===== UI STATES ===== */
function showBooking(){
  title.innerText = "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏¥‡∏ß"
  bookBtn.classList.remove("hidden")
}

function showQueue(d){
  title.innerText = "‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ‡∏Ñ‡∏¥‡∏ß‡πÅ‡∏•‡πâ‡∏ß"
  queueInfo.classList.remove("hidden")
  cancelBtn.classList.remove("hidden")

  queueInfo.innerHTML = `
    üé´ ‡∏Ñ‡∏¥‡∏ß‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì: <b>#${d.queue}</b><br>
    ‚ñ∂ ‡∏Ñ‡∏¥‡∏ß‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: ${d.current}<br>
    ‚è≥ ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏≠‡∏µ‡∏Å: ${d.remain} ‡∏Ñ‡∏¥‡∏ß
  `
}

/* ===== ACTIONS ===== */
function bookQueue(){
  bookBtn.disabled = true

  fetch(API_URL,{
    method:"POST",
    body:JSON.stringify({
      action:"reserve",
      userId: profile.userId,
      name: profile.displayName
    })
  })
  .then(r=>r.json())
  .then(checkQueue)
}

function cancelQueue(){
  if(!confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Ñ‡∏¥‡∏ß?")) return

  fetch(API_URL,{
    method:"POST",
    body:JSON.stringify({
      action:"cancelQueue",
      userId: profile.userId
    })
  })
  .then(()=>location.reload())
}

init()
</script>

</body>
</html>
